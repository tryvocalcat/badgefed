@page "/view/grant/{noteIdParam}"
@using ActivityPubDotNet.Core
@using System.Text.Json
@using Markdig

@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager NavManager
@inject LocalScopedDb DbService
@inject BadgeImageService BadgeImageService
@layout BadgeFed.Components.Layouts.MinimalLayout
@inject IJSRuntime JSRuntime

<HeadContent>
  <meta name="author" content="@badgeRecord!.IssuedBy" />
  <meta name="description" content="@badgeRecord.Title was issued by @actorName to @badgeRecord.IssuedToName" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="@badgeRecord.Title was issued by @actorName to @badgeRecord.IssuedToName" />
  <meta property="og:description" content="@badgeRecord.Description" />
  <meta property="og:url" content="@NavManager.Uri" />
  <meta property="og:image" content="@ogImage" />
  <meta name="fediverse:creator" content="@badgeRecord.IssuerFediverseHandle" />
</HeadContent>

<style>
    a {
        position: relative;
        z-index: 10;
    }
    .tag {
        margin: 0.5rem;
    }
    
    .badge-image-info {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 5;
    }

    .badge-metadata-indicator {
        background: rgba(16, 185, 129, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .badge-image-container {
        position: relative;
    }
    
    .badge-container {
        max-width: 1000px;
        margin: 2rem auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .verification-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
        padding: 2rem;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .verification-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        opacity: 0.1;
    }
    .verification-header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
        position: relative;
        z-index: 2;
    }
    .verification-header-main {
        flex: 1;
    }
    .verification-header-actions {
        flex-shrink: 0;
        display: flex;
        align-items: flex-start;
        margin-top: 0.5rem;
    }
    .certificate-button-header {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        backdrop-filter: blur(10px);
        font-size: 0.9rem;
        min-width: auto;
        white-space: nowrap;
    }
    .certificate-button-header:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        color: white;
    }
    @@media (max-width: 768px) {
        .verification-header-content {
            flex-direction: column;
            gap: 1rem;
        }
        .verification-header-actions {
            align-self: flex-end;
            margin-top: 0;
        }
        .certificate-button-header {
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
        }
    }
    .verification-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        padding: 0.75rem 1.5rem;
        border-radius: 30px;
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 1rem;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .badge-content {
        padding: 3rem;
    }
    .badge-image-container {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 2rem;
    }
    .badge-image {
        max-height: 300px;
        margin: 0 auto;
    }
    .badge-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: #1a1a2e;
    }
    .badge-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .meta-item {
        background: #f3f4f6;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .meta-item i {
        color: #6b7280;
    }
    .badge-description {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #4b5563;
        margin-bottom: 2rem;
        margin-top: 2rem;
    }
    .badge-criteria {
        background: #f3f4f6;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    .criteria-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1a1a2e;
    }
    .security-info {
        background: #f3f4f6;
        padding: 1.5rem;
        border-radius: 12px;
        margin-top: 2rem;
    }
    .security-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1a1a2e;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .fingerprint {
        font-family: monospace;
        background: #1a1a2e;
        color: #10b981;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        word-break: break-all;
    }
    .share-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 2rem;
        align-items: flex-start;
    }
    .share-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        min-height: 48px;
        flex: 1;
        min-width: 200px;
    }
    .share-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .linkedin-post-button {
        background: #0a66c2;
        color: white;
    }
    .linkedin-profile-button {
        background: #0077b5;
        color: white;
    }
    .mastodon-button {
        background: #6364ff;
        color: white;
    }
    .openbadge-button {
        background: #f59e0b;
        color: white;
    }
    .verification-button {
        background: #10b981;
        color: white;
    }
    
    .verify-button {
        background: #10b981;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    .verify-button:hover {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    /* Verification Modal Styles */
    .verification-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        backdrop-filter: blur(4px);
    }
    .verification-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }
    .verification-modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }
    .verification-modal-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px 16px 0 0;
        text-align: center;
        position: relative;
    }
    .verification-modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .verification-modal-body {
        padding: 2rem;
    }
    .verification-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: background 0.3s ease;
    }
    .verification-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    .trust-factor {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }
    .trust-factor:hover {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.02);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .trust-factor-check {
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        background: #10b981;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
        margin-top: 0.2rem;
    }
    .trust-factor-content {
        flex: 1;
    }
    .trust-factor-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: #1f2937;
    }
    .trust-factor-description {
        color: #6b7280;
        font-size: 0.95rem;
        line-height: 1.5;
        margin: 0;
    }
    .trust-factor-value {
        background: #f3f4f6;
        padding: 0.75rem;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.85rem;
        color: #1f2937;
        margin-top: 0.75rem;
        word-break: break-all;
        border-left: 3px solid #10b981;
    }
    .trust-factor-help {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: #e5e7eb;
        color: #6b7280;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        cursor: help;
        transition: all 0.3s ease;
        line-height: 1;
    }
    .trust-factor-help:hover {
        background: #10b981;
        color: white;
    }
    .tooltip {
        position: relative;
        display: inline-block;
    }
    .tooltip .tooltiptext {
        visibility: hidden;
        width: 300px;
        background-color: #1f2937;
        color: white;
        text-align: left;
        border-radius: 8px;
        padding: 0.75rem;
        position: absolute;
        z-index: 10001;
        bottom: 125%;
        right: 0;
        font-size: 0.85rem;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s;
    }
    .tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        right: 20px;
        border-width: 8px;
        border-style: solid;
        border-color: #1f2937 transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @@keyframes slideUp {
        from { 
            opacity: 0; 
            transform: translateY(30px) scale(0.95); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
        }
    }
    
    @@media (max-width: 768px) {
        .verification-modal-content {
            width: 95%;
            margin: 1rem;
        }
        .verification-modal-body {
            padding: 1.5rem;
        }
        .trust-factor {
            padding: 1rem;
        }
        .tooltip .tooltiptext {
            width: 250px;
            right: -50px;
        }
    }
    
    .metadata-info-section {
        margin: 2rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }
    
    .metadata-info-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .metadata-info-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1a2e;
    }
    
    .metadata-info-title .icon {
        color: #10b981;
    }
    
    .metadata-info-section p {
        margin-bottom: 1rem;
        color: #4a5568;
        line-height: 1.6;
    }
    
    .metadata-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .metadata-action-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 8px;
        background: #10b981;
        color: white;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .metadata-action-button:hover {
        background: #059669;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }
    
    .metadata-action-button.secondary {
        background: #6b7280;
        box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
    }
    
    .metadata-action-button.secondary:hover {
        background: #4b5563;
        box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
    }
    
    .owner-actions-section {
        margin-top: 2rem;
        border-top: 2px solid #f3f4f6;
        padding-top: 2rem;
    }
    .owner-actions-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .owner-actions-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a1a2e;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .owner-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-weight: 500;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .owner-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    .owner-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        min-height: 48px;
        border: 2px solid;
        background: white;
    }
    .owner-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .owner-button.linkedin {
        border-color: #0077b5;
        color: #0077b5;
    }
    .owner-button.linkedin:hover {
        background: #0077b5;
        color: white;
    }
    .owner-button.openbadge {
        border-color: #f59e0b;
        color: #f59e0b;
    }
    .owner-button.openbadge:hover {
        background: #f59e0b;
        color: white;
    }
    .owner-button.copy {
        border-color: #6366f1;
        color: #6366f1;
    }
    .owner-button.copy:hover {
        background: #6366f1;
        color: white;
    }
    .owner-button.settings {
        border-color: #6b7280;
        color: #6b7280;
        opacity: 0.6;
        cursor: not-allowed;
    }
    .owner-button.settings:hover {
        transform: none;
        box-shadow: none;
    }
    .toggle-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        color: #475569;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    .toggle-button:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
    }
    .toggle-button.expanded {
        background: #1a1a2e;
        color: white;
        border-color: #1a1a2e;
    }
    .owner-actions-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
    }
    .owner-actions-content.show {
        max-height: 300px;
    }
    .comments-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
    }
    .comment-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .comment-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .comment-author {
        font-weight: 600;
        color: #1a1a2e;
    }
    .comment-date {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    @@media (max-width: 768px) {
        .share-actions {
            grid-template-columns: 1fr;
        }
        .badge-meta {
            flex-direction: column;
        }
    }

    /* Certificate/Diploma Styles */
    .certificate-container {
        max-width: 1200px;
        margin: 2rem auto;
        background: url('/img/certificate-background.png') center center / contain;
        background-color: #f8f9ff;
        border: 8px solid #1a1a2e;
        border-radius: 0;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
    }
    .certificate-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(248, 249, 255, 0.85);
        pointer-events: none;
        z-index: 1;
    }
    .certificate-container::after {
        content: '';
        position: absolute;
        top: 30px;
        left: 30px;
        right: 30px;
        bottom: 30px;
        border: 1px solid #1a1a2e;
        pointer-events: none;
        z-index: 2;
    }
    .certificate-header {
        text-align: center;
        padding: 3rem 4rem 2rem;
        position: relative;
        z-index: 2;
        font-size: 2rem;
         font-family: 'Times New Roman', serif;
    }
    .certificate-header text {
        fill: #FF9800;
    }
    .certificate-header path {
        fill: transparent;
    }
    .certificate-title {
        font-family: 'Times New Roman', serif;
        font-size: 4rem;
        font-weight: normal;
        color: #1a1a2e;
        margin-bottom: 0.2rem;
        margin-top: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        position: relative;
        display: inline-block;
        letter-spacing: 0.1em;
        transform-style: preserve-3d;
    }
 
    .certificate-subtitle {
        font-family: 'Times New Roman', serif;
        font-size: 1.5rem;
        color: #4a5568;
        margin-bottom: 0.5rem;
        font-style: italic;
    }
    .certificate-content {
        text-align: center;
        padding: 0.5rem 2rem;
        position: relative;
        z-index: 2;
    }
    .certificate-recipient {
        font-family: 'Times New Roman', serif;
        font-size: 1.3rem;
        color: #2d3748;
        margin-bottom: 0.2rem;
    }
    .certificate-recipient-name {
        font-family: 'Times New Roman', serif;
        font-size: 2.5rem;
        font-weight: bold;
        color: #1a1a2e;
        margin: 0.3rem 0 0.5rem;
        text-decoration: underline;
        text-decoration-thickness: 2px;
        text-underline-offset: 8px;
    }
    .certificate-achievement {
        font-family: 'Times New Roman', serif;
        font-size: 1.3rem;
        color: #2d3748;
        margin-bottom: 0.3rem;
        line-height: 1.6;
    }
    .certificate-badge-title {
        font-family: 'Times New Roman', serif;
        font-size: 2rem;
        font-weight: bold;
        color: #1a1a2e;
        margin: 0.5rem 0;
        text-transform: uppercase;
        letter-spacing: 2px;
    }
    .certificate-description {
        font-family: 'Times New Roman', serif;
        font-size: 1.1rem;
        color: #4a5568;
        margin: 1rem auto;
        max-width: 820px;
        line-height: 1.6;
    }
    .certificate-footer {
        display: flex;
        justify-content: space-between;
        align-items: end;
        padding: 1rem 4rem;
        margin-top: 0.1rem;
        position: relative;
        z-index: 2;
    }
    .certificate-issuer {
        text-align: left;
        flex: 1;
    }
    .certificate-date {
        text-align: right;
        flex: 1;
    }
    .certificate-seal {
        text-align: center;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .certificate-issuer-name,
    .certificate-date-value {
        font-family: 'Times New Roman', serif;
        font-size: 1.2rem;
        font-weight: bold;
        color: #1a1a2e;
        margin-bottom: 0.3rem;
        border-bottom: 2px solid #1a1a2e;
        padding-bottom: 5px;
        display: inline-block;
    }
    .certificate-issuer-title,
    .certificate-date-label {
        font-family: 'Times New Roman', serif;
        font-size: 0.9rem;
        color: #4a5568;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .certificate-seal-image {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 3px solid #1a1a2e;
        object-fit: cover;
        background: white;
        padding: 10px;
        display: block;
        margin: 0 auto;
    }
    .certificate-ornament {
        position: absolute;
        font-size: 2rem;
        color: #1a1a2e;
        opacity: 0.4;
    }
    .certificate-ornament.top-left {
        top: 50px;
        left: 50px;
    }
    .certificate-ornament.top-right {
        top: 50px;
        right: 50px;
    }
    .certificate-ornament.bottom-left {
        bottom: 50px;
        left: 50px;
    }
    .certificate-ornament.bottom-right {
        bottom: 50px;
        right: 50px;
    }
    .certificate-verification {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.4rem 1.5rem;
        margin: 3rem 6rem;
        text-align: center;
        position: relative;
        z-index: 2;
    }
    .certificate-verification-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1a2e;
        margin-bottom: 0.3rem;
    }
    .certificate-verification-text {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.3rem;
    }
    .certificate-fingerprint {
        font-family: monospace;
        font-size: 0.8rem;
        background: #1a1a2e;
        color: #10b981;
        padding: 0.5rem;
        border-radius: 4px;
        word-break: break-all;
    }
    .certificate-qr-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
    }
    .certificate-qr-code {
        text-align: center;
        flex-shrink: 0;
    }
    .certificate-qr-image {
        width: 80px;
        height: 80px;
        border: 2px solid #1a1a2e;
        border-radius: 4px;
        background: white;
        padding: 4px;
    }
    .certificate-qr-label {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 0.25rem;
        font-family: 'Times New Roman', serif;
    }
    .certificate-fingerprint-section {
        flex: 1;
    }
    
    @@media (max-width: 768px) {
        .certificate-container {
            margin: 1rem;
            border-width: 4px;
        }
        .certificate-header,
        .certificate-content,
        .certificate-footer {
            padding: 2rem;
        }
        .certificate-title {
            font-size: 2.5rem;
        }
        .certificate-title-arced {
            height: 80px;
            margin: 0.5rem 0 1.5rem 0;
        }
        .certificate-recipient-name {
            font-size: 2rem;
        }
        .certificate-badge-title {
            font-size: 1.5rem;
        }
        .certificate-footer {
            flex-direction: column;
            gap: 2rem;
            text-align: center;
        }
        .certificate-verification {
            margin: 2rem 1rem;
        }
        .certificate-qr-section {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
        .certificate-qr-code {
            order: -1;
        }
    }

    /* Modal Styles */
    .certificate-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        overflow: auto;
    }
    .certificate-modal.show {
        display: block;
    }
    .modal-content {
        position: relative;
        background-color: white;
        margin: 2% auto;
        padding: 0;
        width: 95%;
        max-width: 1200px;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-height: 95vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: #1a1a2e;
        color: white;
        border-radius: 8px 8px 0 0;
    }
    .modal-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
    .modal-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    .modal-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    .print-button {
        background: #10b981;
        color: white;
    }
    .print-button:hover {
        background: #059669;
        color: white;
    }
    .close-button {
        background: transparent;
        color: white;
        border: 2px solid white;
    }
    .close-button:hover {
        background: white;
        color: #1a1a2e;
    }
    .modal-body {
        padding: 0;
    }
    
    /* Print-specific styles */
    @@media print {
        body * {
            visibility: hidden;
        }
        .certificate-modal, .certificate-modal * {
            visibility: visible;
        }
        .certificate-modal {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: white !important;
            display: block !important;
        }
        .modal-content {
            margin: 0;
            width: 100%;
            max-width: none;
            box-shadow: none;
            border-radius: 0;
            max-height: none;
            overflow: visible;
        }
        .modal-header {
            display: none !important;
        }
        .modal-body {
            padding: 0;
        }
        .certificate-container {
            margin: 0;
            box-shadow: none;
            max-width: none;
            page-break-inside: avoid;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        .certificate-qr-image {
            width: 60px;
            height: 60px;
        }
    }
</style>

<div class="badge-container">
    <div class="verification-header">
        <div class="verification-header-content">
            <div class="verification-header-main">
                <div class="verification-badge">
                    <span class="icon"><i class="fas fa-shield-alt"></i></span>
                    <span>Verified Badge</span>
                </div>
                <h1 class="title is-3 has-text-white">@badgeRecord.Title</h1>
                <p class="subtitle is-5 has-text-white-bis">Issued to <a href="@badgeRecord.IssuedToSubjectUri">@badgeRecord.IssuedToName</a> on @badgeRecord.IssuedOn.ToString("MMMM d, yyyy")</p>
            </div>
            @if (badge?.IsCertificate == true && !badgeRecord.IsExternal)
            {
                <div class="verification-header-actions">
                    <button class="certificate-button-header" onclick="openCertificateModal()">
                        <span class="icon"><i class="fas fa-award"></i></span>
                        <span>View as Certificate</span>
                    </button>
                </div>
            }
        </div>
    </div>


    <div class="badge-content">
        <div class="badge-image-container">
            <img src="@GetBadgeImageWithMetadataUrl()" alt="@badgeRecord.ImageAltText" class="badge-image">
            <div class="badge-image-info">
                <span class="badge-metadata-indicator" title="This image contains embedded OpenBadge metadata for verification">
                    <i class="fas fa-certificate"></i> Verifiable Image
                </span>
            </div>
        </div>

        <div class="badge-meta">
                <div class="meta-item">
                    <span class="icon"><i class="fas fa-user"></i></span>
                    <span>Issued by <a href="@actorUri" class="has-text-primary">@actorName</a></span>
                </div>
                <div class="meta-item">
                    <span class="icon"><i class="fas fa-calendar"></i></span>
                    <span>Accepted on @(badgeRecord.AcceptedOn?.ToString("MMMM d, yyyy") ?? "N/A")</span>
                </div>
            
                @if (badgeRecord.IsExternal)
                {
                    <div class="meta-item" style="background-color: #f0ad4e; color: white;">
                        <span class="icon"><i class="fas fa-external-link-alt"></i></span>
                        <span>External Issuer</span>
                    </div>
                }
                else
                {
                    <div class="meta-item">
                        <span class="icon"><i class="fas fa-tag"></i></span>
                        <span>@badge?.BadgeType</span>
                    </div>
                }
        </div>
        
        @if (badgeRecord.HashtagsList != null && badgeRecord.HashtagsList.Any())
        {
            <div class="hashtags mt-2">
                @foreach (var hashtag in badgeRecord.HashtagsList)
                {
                    <span class="tag is-small @GetRandomTagColor(hashtag)">#@hashtag.Trim()</span>
                }
            </div>
        }

        <div class="badge-description">
            @badgeRecord.Description
        </div>

        <div class="badge-criteria">
            <div class="criteria-title">
                <i class="fas fa-graduation-cap" style="color: #1a1a2e;"></i>
                Earning Criteria
            </div>
            @((MarkupString)Markdown.ToHtml(badgeRecord.EarningCriteria ?? string.Empty))
            @if (!string.IsNullOrEmpty(badgeRecord.Badge?.InfoUri))
            {
                <div class="mt-3">
                    <a href="@badgeRecord.Badge.InfoUri" target="_blank" class="button is-small is-outlined is-info">
                        <span class="icon">
                            <i class="fas fa-external-link-alt"></i>
                        </span>
                        <span>Learn More About This Program</span>
                    </a>
                </div>
            }
        </div>

        <div class="security-info">
            <h3 class="security-title">
                <span class="icon"><i class="fas fa-shield-check"></i></span>
                <span>Verification & Trust</span>
            </h3>
            <p>This badge has been cryptographically verified and securely recorded.</p>
            <div style="margin-top: 1rem;">
                <button class="verify-button" onclick="openVerificationModal()">
                    <span class="icon"><i class="fas fa-check-circle"></i></span>
                    <span>Verify Badge Trust Factors</span>
                </button>
            </div>
        </div>

        @if (!badgeRecord.IsExternal)
        {
            <div class="metadata-info-section">
                <h4 class="metadata-info-title">
                    <span class="icon"><i class="fas fa-certificate"></i></span>
                    <span>Verifiable Badge Image</span>
                </h4>
                <p>This badge image contains embedded OpenBadge metadata. Right-click and save the image above to download a self-contained, verifiable badge file that includes all verification data. <a href="/badge-verification-help" target="_blank">Learn more about verification</a>.</p>
                <div class="metadata-actions">
                    <a href="@GetBadgeImageWithMetadataUrl()" download="verified-badge-@(NoteIdParam).png" class="metadata-action-button">
                        <span class="icon"><i class="fas fa-download"></i></span>
                        <span>Download Verifiable Image</span>
                    </a>
                    <a href="/badge-image/@(NoteIdParam)/metadata" target="_blank" class="metadata-action-button secondary">
                        <span class="icon"><i class="fas fa-code"></i></span>
                        <span>View Embedded JSON</span>
                    </a>
                </div>
            </div>
        }

        <div class="share-actions">
           

            <!-- Public Sharing Options -->
            <!-- Mastodon Share -->
            <a href="@ShareHelper.GetMastodonShareLink(badgeRecord)" 
               class="share-button mastodon-button"
               target="_blank">
                <span class="icon"><i class="fab fa-mastodon"></i></span>
                <span>Share on Mastodon</span>
            </a>

            <!-- LinkedIn Share as Post -->
            @{
                var linkedinPostShareLink = ShareHelper.GetLinkedInPostShareLink(badgeRecord);
            }
            @if(!string.IsNullOrEmpty(linkedinPostShareLink))
            {
                <a href="@linkedinPostShareLink" 
                   class="share-button linkedin-post-button"
                   target="_blank">
                    <span class="icon"><i class="fab fa-linkedin"></i></span>
                    <span>Share on LinkedIn</span>
                </a>
            }

            <!-- Independent Verification Button -->
            @{
                var openBadgeUrl = $"{NavManager.BaseUri.TrimEnd('/')}/openbadge/{badgeRecord.NoteId.Split('/').LastOrDefault()}";
                var recipientUrl = badgeRecord.IssuedToSubjectUri;
                var verificationUrl = $"https://badgecheck.us.badgr.com/?url={openBadgeUrl}&identity__url={recipientUrl}";
            }
            <a href="@verificationUrl" 
               class="share-button verification-button" 
               target="_blank">
                <span class="icon"><i class="fas fa-check-circle"></i></span>
                <span>Verify Independently</span>
            </a>

        </div>

        <!-- Owner Actions Section -->
        <div class="owner-actions-section">
            <div class="owner-actions-header">
                <div class="owner-actions-title">
                    <i class="fas fa-user-shield"></i>
                    Owner Actions
                </div>
                <div class="owner-badge">
                    <i class="fas fa-crown"></i>
                    Badge Owner Only
                </div>
                <button class="toggle-button" onclick="toggleOwnerActions()" id="toggleBtn">
                    <i class="fas fa-chevron-down" id="chevronIcon"></i>
                    <span id="toggleText">Show Actions</span>
                </button>
            </div>
            
            <div class="owner-actions-content" id="ownerActionsContent">
                <div class="owner-actions-grid">
                    @{
                        var linkedinProfileLink = ShareHelper.GetLinkedInProfileLink(badgeRecord);
                        var badgeId = badgeRecord.NoteId.Split('/').LastOrDefault();
                    }
                    
                    @if(!string.IsNullOrEmpty(linkedinProfileLink))
                    {
                        <a href="@linkedinProfileLink" 
                           class="owner-button linkedin"
                           target="_blank">
                            <span class="icon"><i class="fab fa-linkedin"></i></span>
                            <span>Add to LinkedIn Profile</span>
                        </a>
                    }
                    
                    <a href="javascript:void(0)" 
                       class="owner-button copy"
                       onclick="copyBadgeUrl()">
                        <span class="icon"><i class="fas fa-copy"></i></span>
                        <span>Copy Badge URL</span>
                    </a>
                    
                    <a href="javascript:void(0)" 
                       class="owner-button settings"
                       title="Coming soon - manage badge settings">
                        <span class="icon"><i class="fas fa-cog"></i></span>
                        <span>Badge Settings</span>
                    </a>
                </div>
            </div>
        </div>

        <script>
            function toggleOwnerActions() {
                const content = document.getElementById('ownerActionsContent');
                const toggleBtn = document.getElementById('toggleBtn');
                const chevron = document.getElementById('chevronIcon');
                const toggleText = document.getElementById('toggleText');
                
                content.classList.toggle('show');
                toggleBtn.classList.toggle('expanded');
                
                if (content.classList.contains('show')) {
                    chevron.style.transform = 'rotate(180deg)';
                    toggleText.textContent = 'Hide Actions';
                } else {
                    chevron.style.transform = 'rotate(0deg)';
                    toggleText.textContent = 'Show Actions';
                }
            }
            
            function copyBadgeUrl() {
                navigator.clipboard.writeText(window.location.href).then(function() {
                    // Create a simple toast notification
                    const toast = document.createElement('div');
                    toast.textContent = 'Badge URL copied to clipboard!';
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: 500;
                        z-index: 10000;
                        animation: slideInRight 0.3s ease-out;
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                }).catch(function() {
                    alert('Failed to copy URL to clipboard');
                });
            }

            function openCertificateModal() {
                document.getElementById('certificateModal').classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            function closeCertificateModal() {
                document.getElementById('certificateModal').classList.remove('show');
                document.body.style.overflow = 'auto';
            }

            function printCertificate() {
                window.print();
            }

            function openVerificationModal() {
                document.getElementById('verificationModal').classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            function closeVerificationModal() {
                document.getElementById('verificationModal').classList.remove('show');
                document.body.style.overflow = 'auto';
            }

            // Close modal when clicking outside of it
            window.onclick = function(event) {
                const certificateModal = document.getElementById('certificateModal');
                const verificationModal = document.getElementById('verificationModal');
                
                if (event.target === certificateModal) {
                    closeCertificateModal();
                }
                
                if (event.target === verificationModal) {
                    closeVerificationModal();
                }
            }

            // Close modal with escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeCertificateModal();
                    closeVerificationModal();
                }
            });
        </script>
    </div>
</div>

<!-- Certificate Modal -->
@if (badge?.IsCertificate == true && !badgeRecord.IsExternal)
{
    <div id="certificateModal" class="certificate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Certificate View</h3>
                <div class="modal-actions">
                    <button class="modal-button print-button" onclick="printCertificate()">
                        <i class="fas fa-print"></i>
                        <span>Print Certificate</span>
                    </button>
                    <button class="modal-button close-button" onclick="closeCertificateModal()">
                        <i class="fas fa-times"></i>
                        <span>Close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Certificate Content -->
                <div class="certificate-container">
                    <!-- Decorative ornaments -->
                    <div class="certificate-ornament top-left">❦</div>
                    <div class="certificate-ornament top-right">❦</div>
                    <div class="certificate-ornament bottom-left">❦</div>
                    <div class="certificate-ornament bottom-right">❦</div>
                    
                    <div class="certificate-header">
                        <div class="verification-badge" style="display: inline-flex; margin-bottom: 2rem;">
                            <span class="icon"><i class="fas fa-shield-alt"></i></span>
                            <span>Verified Certificate</span>
                        </div>
                        <div class="certificate-title-arced">
                            <h1 class="certificate-title" data-text="Certificate of Achievement">Certificate of Achievement</h1>
                        </div>
                    </div>

                    <div class="certificate-content">
                        <div class="certificate-recipient">
                            <p class="certificate-recipient">Presented to:</p>
                            <h2 class="certificate-recipient-name">@badgeRecord.IssuedToName</h2>
                        </div>
                        
                        <p class="certificate-achievement">for successfully completing the requirements and earning the</p>
                        
                        <h3 class="certificate-badge-title">@badgeRecord.Title</h3>
                        
                        <div class="certificate-description">
                            @badgeRecord.Description
                        </div>
                        
                     </div>

                    <div class="certificate-footer">
                        <div class="certificate-issuer">
                            <div class="certificate-issuer-name">@actorName</div>
                            <div class="certificate-issuer-title">Authorized Issuer</div>
                        </div>
                        
                        <div class="certificate-seal">
                            @if (!string.IsNullOrEmpty(badgeRecord.FullImageUrl))
                            {
                                <img src="@badgeRecord.FullImageUrl" alt="@badgeRecord.ImageAltText" class="certificate-seal-image">
                            }
                        </div>
                        
                        <div class="certificate-date">
                            <div class="certificate-date-value">@badgeRecord.IssuedOn.ToString("MMMM d, yyyy")</div>
                            <div class="certificate-date-label">Date Issued</div>
                        </div>
                    </div>

                    <div class="certificate-verification">
                        <div class="certificate-verification-title">Digital Verification</div>
                        <div class="certificate-qr-section">
                            <div class="certificate-fingerprint-section">
                            <div class="certificate-verification-text">
                                This certificate has been cryptographically verified and is securely recorded on the decentralized web.
                            </div>
                           
                                <div class="certificate-fingerprint">
                                    @badgeRecord.FingerPrint.ToUpper()
                                </div>
                            </div>
                            <div class="certificate-qr-code">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=@Uri.EscapeDataString(NavManager.Uri)" 
                                     alt="QR Code to verify certificate" 
                                     class="certificate-qr-image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Verification Modal -->
<div id="verificationModal" class="verification-modal">
    <div class="verification-modal-content">
        <div class="verification-modal-header">
            <h2 class="verification-modal-title">
                <i class="fas fa-shield-check"></i>
                Badge Trust Factors
            </h2>
            <button class="verification-close" onclick="closeVerificationModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="verification-modal-body">
            <p style="text-align: center; margin-bottom: 2rem; color: #6b7280; font-size: 1rem;">
                Here are the verifiable trust factors that prove this badge's authenticity and integrity:
            </p>

            <!-- Cryptographic Signature -->
            <div class="trust-factor">
                <div class="trust-factor-check">
                    <i class="fas fa-signature"></i>
                </div>
                <div class="trust-factor-content">
                    <h4 class="trust-factor-title">Cryptographic Signature</h4>
                    <p class="trust-factor-description">
                        Unique cryptographic fingerprint prevents counterfeiting.<br>
                        <small style="color: #9ca3af; font-style: italic;">Like a unique DNA that can't be faked - so you know this badge is 100% real and hasn't been tampered with.</small>
                    </p>
                    <div class="trust-factor-value">@badgeRecord.FingerPrint.ToUpper()</div>
                </div>
                <div class="trust-factor-help tooltip">
                    <i class="fas fa-question" style="padding: 8px"></i>
                    <span class="tooltiptext">
                        This SHA-256 hash is generated from the badge's content and metadata, creating an unforgeable digital signature. Any alteration to the badge would result in a completely different fingerprint, making it virtually impossible to counterfeit while ensuring complete data integrity and authenticity verification.
                    </span>
                </div>
            </div>

            <!-- Issuer Domain Authority -->
            <div class="trust-factor">
                <div class="trust-factor-check">
                    <i class="fas fa-building"></i>
                </div>
                <div class="trust-factor-content">
                    <h4 class="trust-factor-title">Verified Issuer Domain</h4>
                    <p class="trust-factor-description">
                        Issuer controls verified domain with institutional accountability.<br>
                        <small style="color: #9ca3af; font-style: italic;">Like checking that a diploma really came from the school it claims - so you know it's not from a fake organization.</small>
                    </p>
                    <div class="trust-factor-value">@actorUri.Host</div>
                </div>
                <div class="trust-factor-help tooltip">
                    <i class="fas fa-question"></i>
                    <span class="tooltiptext">
                        Domain verification ensures that only the legitimate organization can issue badges from this domain. The issuer has been registered and issuing badges since their domain registration, providing institutional accountability and preventing impersonation attacks. This establishes organizational trust and credibility.
                    </span>
                </div>
            </div>

            @if (!badgeRecord.IsExternal)
            {
                <!-- ActivityPub Federation -->
                <div class="trust-factor">
                    <div class="trust-factor-check">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="trust-factor-content">
                        <h4 class="trust-factor-title">Decentralized Network Verification</h4>
                        <p class="trust-factor-description">
                            Published on decentralized Fediverse for transparent verification.<br>
                            <small style="color: #9ca3af; font-style: italic;">Your badge exists on many computers, not just one - so it can't disappear if one company goes out of business.</small>
                        </p>
                        <div class="trust-factor-value">ActivityPub Protocol</div>
                    </div>
                    <div class="trust-factor-help tooltip">
                        <i class="fas fa-question"></i>
                        <span class="tooltiptext">
                            ActivityPub is a decentralized social networking protocol that ensures your badge exists on multiple independent servers across the Fediverse, providing transparent and public verification. This prevents single points of failure, censorship, and ensures the badge remains accessible and verifiable even if one server goes offline.
                        </span>
                    </div>
                </div>

                <!-- OpenBadges Standard -->
                <div class="trust-factor">
                    <div class="trust-factor-check">
                        <i class="fas fa-certificate"></i>
                    </div>
                    <div class="trust-factor-content">
                        <h4 class="trust-factor-title">Open Badge Standard Compliance</h4>
                        <p class="trust-factor-description">
                            Follows global standard for interoperability and verification.<br>
                            <small style="color: #9ca3af; font-style: italic;">Like having a universally accepted driver's license that works everywhere - so other organizations will recognize and trust your badge.</small>
                        </p>
                        <div class="trust-factor-value">Open Badge v3.0 Specification</div>
                    </div>
                    <div class="trust-factor-help tooltip">
                        <i class="fas fa-question"></i>
                        <span class="tooltiptext">
                            Open Badges is a globally recognized industry standard maintained by 1EdTech that ensures badges can be verified by any compliant system worldwide. This provides universal recognition, portability across platforms, and independent verification by third-party tools, making your badge internationally trusted and transferable.
                        </span>
                    </div>
                </div>
            }

            <!-- Timestamp Verification -->
            <div class="trust-factor">
                <div class="trust-factor-check">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="trust-factor-content">
                    <h4 class="trust-factor-title">Tamper-Evident Timestamp</h4>
                    <p class="trust-factor-description">
                        Cryptographically protected issuance date prevents backdating.<br>
                        <small style="color: #9ca3af; font-style: italic;">Like a permanent marker that can't be erased or changed - so no one can fake when you earned this achievement.</small>
                    </p>
                    <div class="trust-factor-value">@badgeRecord.IssuedOn.ToString("yyyy-MM-dd HH:mm:ss UTC")</div>
                </div>
                <div class="trust-factor-help tooltip">
                    <i class="fas fa-question"></i>
                    <span class="tooltiptext">
                        The timestamp is cryptographically included in the badge signature, making it impossible to alter the issuance date or backdate the badge without completely invalidating the entire signature. This prevents fraudulent claims about when achievements were earned and ensures chronological integrity.
                    </span>
                </div>
            </div>

            <!-- Recipient Verification -->
            <div class="trust-factor">
                <div class="trust-factor-check">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="trust-factor-content">
                    <h4 class="trust-factor-title">Recipient Identity Verification</h4>
                    <p class="trust-factor-description">
                        Identity cryptographically linked to prevent theft.<br>
                        <small style="color: #9ca3af; font-style: italic;">Like your name being permanently written inside - so no one else can steal your badge and pretend they earned it.</small>
                    </p>
                    <div class="trust-factor-value">@badgeRecord.IssuedToName</div>
                </div>
                <div class="trust-factor-help tooltip">
                    <i class="fas fa-question"></i>
                    <span class="tooltiptext">
                        The recipient's identity is verified through their authenticated account credentials and cryptographically linked to the badge signature, ensuring only the rightful owner can legitimately present this badge. This prevents badge theft, impersonation, and unauthorized use by other parties.
                    </span>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(badgeRecord.Badge?.InfoUri))
            {
                <!-- Badge Program Verification -->
                <div class="trust-factor">
                    <div class="trust-factor-check">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="trust-factor-content">
                        <h4 class="trust-factor-title">Verified Badge Program</h4>
                        <p class="trust-factor-description">
                            Established program with published criteria and standards.<br>
                            <small style="color: #9ca3af; font-style: italic;">Like a recipe book that shows exactly what you did to earn this - there's a public webpage that anyone can check to see the requirements weren't made up or hidden.</small>
                        </p>
                        <div class="trust-factor-value">
                            <a href="@badgeRecord.Badge.InfoUri" target="_blank" style="color: #10b981; text-decoration: none;">
                                View Program Information
                                <i class="fas fa-external-link-alt" style="margin-left: 0.5rem; font-size: 0.8rem;"></i>
                            </a>
                        </div>
                    </div>
                    <div class="trust-factor-help tooltip">
                        <i class="fas fa-question"></i>
                        <span class="tooltiptext">
                            This badge is part of an established program with publicly available information about the specific criteria, requirements, learning outcomes, and standards that must be met to earn the badge. This transparency establishes credibility and allows others to understand the achievement's value and rigor.
                        </span>
                    </div>
                </div>
            }

            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; text-align: center;">
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    <i class="fas fa-shield-alt" style="color: #10b981; margin-right: 0.5rem;"></i>
                    All trust factors have been verified and are cryptographically secured.
                </p>
            </div>
        </div>
    </div>
</div>

@if (badgeRecord.IsExternal)
{
    <div class="notification is-warning">
        This badge was issued externally. You can view it on the original platform by clicking the button below.
        <a href="@badgeRecord.NoteId" class="button is-light">View Badge</a>
    </div>
} else {
    <div class="badge-container comments-section">
        <h3 class="title is-4" style="margin-left: 1.5em">Comments</h3>
        
        <div class="mb-3" style="margin-left: 1.5em">
            <p>To leave a comment, reply to this badge from your Fediverse account. Just copy the badge URL and paste it into your post.</p>
        </div>
        @if (comments == null || !comments.Any())
        {
            <div class="has-text-centered py-4">
                <p class="has-text-grey">No comments yet. Be the first to comment!</p>
            </div>
        }
        else
        {
            <script>
                var comments = @((MarkupString)@JsonSerializer.Serialize(comments));
            
                function getStatusUrl(originalUrl) {
                    // Parse the original URL
                    let url = new URL(originalUrl);
                    
                    // Extract the host and id
                    let host = url.host;
                    let id = url.pathname.split('/').pop(); // Extract the id from the last part of the pathname
                    
                    // Construct the modified URL
                    let modifiedUrl = "https://" + host + "/api/v1/statuses/" + id;
                    
                    return modifiedUrl;
                }

                document.addEventListener('DOMContentLoaded', function() {
                    var commentsWrapper = document.querySelector(".comments-wrapper");

                    if (comments && comments.length > 0) {
                        Promise.all(
                            comments.map(replyId => 
                                fetch(getStatusUrl(replyId), {
                                    headers: { 
                                        'Content-Type': 'application/activity+json', 
                                        'Accept': 'application/activity+json' 
                                    }
                                })
                                .then(response => response.ok ? response.json() : null)
                                .catch(() => null)
                            )
                        ).then(responses => {
                            const validResponses = responses.filter(r => r);
                            validResponses.sort((a, b) => new Date(a.published) - new Date(b.published));
                            
                            if (validResponses.length > 0) {
                                commentsWrapper.innerHTML = validResponses.map(status => {
                                    return `
                                        <div class="comment-card">
                                            <div class="comment-header">
                                                <div class="comment-avatar">
                                                    <span class="icon"><img src="${status.account.avatar}" /></span>
                                                </div>
                                                <div>
                                                    <div class="comment-author">${status.account ? status.account.display_name || status.account.acct : 'Anonymous'}</div>
                                                    <div class="comment-date">${status.created_at}</div>
                                                </div>
                                            </div>
                                            <div class="comment-content">
                                                ${status.content || ''}
                                            </div>
                                        </div>
                                    `;
                                }).join("");
                            }
                        });
                    }
                });
            
            </script>
            <div class="comments-wrapper">
                <div class="comment-card">
                    <div class="comment-header">
                        <div class="comment-avatar">
                            <span class="icon"><i class="fas fa-user"></i></span>
                        </div>
                        <div>
                            <div class="comment-author"></div>
                            <div class="comment-date"></div>
                        </div>
                    </div>
                    <div class="comment-content">
                    
                    </div>
                </div>
            </div>
            
        }
    </div>
}

@code {
    private List<string> comments = new List<string>();
    [Parameter] public string? NoteIdParam { get; set; }
    private BadgeRecord? badgeRecord;
    private Badge? badge;
    private Uri actorUri;

    private string actorName = string.Empty;
    private string ogImage = string.Empty;

    private static readonly string[] TagColors = {
        "is-primary", "is-link", "is-info", "is-success", "is-warning", "is-danger",
        "is-light", "is-dark", "is-primary is-light", "is-link is-light", 
        "is-info is-light", "is-success is-light", "is-warning is-light"
    };

    private string GetRandomTagColor(string hashtag)
    {
        // Use hashtag's hash code to ensure consistent color for same hashtag
        var hash = hashtag.GetHashCode();
        var index = Math.Abs(hash) % TagColors.Length;
        return TagColors[index];
    }

    private string GetBadgeImageWithMetadataUrl()
    {
        if (badgeRecord == null || string.IsNullOrEmpty(NoteIdParam))
        {
            return badgeRecord?.FullImageUrl ?? "";
        }

        // For external badges, use the original image URL
        if (badgeRecord.IsExternal)
        {
            return badgeRecord.FullImageUrl;
        }

        // For local badges, use the image with embedded metadata
        var noteId = NoteIdParam.Trim();
        return BadgeImageService.GetBadgeImageWithMetadataUrl(NavManager.BaseUri, noteId);
    }

    private async Task CopyToClipboard()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", NavManager.Uri);
    }

    protected override async Task OnInitializedAsync()
    {
        var acceptHeader = HttpContextAccessor.HttpContext?.Request.Headers["Accept"].ToString();

        NoteIdParam = NoteIdParam?.Trim();

        if (BadgeFed.Core.ActivityPubHelper.IsActivityPubRequest(acceptHeader))
        {
            NavManager.NavigateTo($"/grant/{NoteIdParam}");
        }
        
        badgeRecord = DbService.GetGrantByNoteId(NoteIdParam);

        if (badgeRecord == null)
        {
            return;
        }

        if (badgeRecord.IsExternal) {
            actorUri = new Uri(badgeRecord.IssuedBy);
         
            var issuer = DbService.GetFollowedIssuerByUrl(badgeRecord.IssuedBy);

            if (issuer != null)
            {
                actorName = issuer.Name + "@" + actorUri.Host;
            } else {
                actorName = badgeRecord.IssuedBy.Split('/').LastOrDefault() ?? string.Empty + "@" + actorUri.Host;
            }

            ogImage = badgeRecord.FullImageUrl;
        } else {
            badge = DbService.GetBadgeDefinitionById(badgeRecord.Badge.Id);
            badgeRecord.Badge = badge;
            badgeRecord.Actor = DbService.GetActorById(badge.IssuedBy);
            actorUri = badgeRecord.Actor.Uri;
            actorName = badgeRecord.Actor.FullName;

            var extension = Path.GetExtension(badgeRecord.Image);
            var directory = Path.GetDirectoryName(badgeRecord.Image);
            var filename = Path.GetFileNameWithoutExtension(badgeRecord.Image);
            var ogFileImage = Path.Combine(directory ?? "", $"{filename}-share{extension}");

            ogImage = $"{NavManager.BaseUri.TrimEnd('/')}{ogFileImage}";

            comments = DbService.GetBadgeComments(badgeRecord.Id);
        }
    }
}