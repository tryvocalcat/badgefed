@page "/admin/grants"

@using System.IO
@using Microsoft.AspNetCore.Hosting
@using Microsoft.AspNetCore.Components.Forms
@inject IWebHostEnvironment Environment
@inject NavigationManager NavigationManager
@inject LocalScopedDb LocalDbService
@inject CurrentUser CurrentUser
@layout BadgeFed.Components.Layouts.AdminLayout
@rendermode InteractiveServer

@attribute [Authorize(Roles = "admin, manager")]

<style>
    .table {
        width: 100%;
    }
    
    .actions-column {
        min-width: 280px;
        white-space: nowrap;
    }
    
    .issued-to-column {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .issued-to-column a {
        display: block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-decoration: underline;
    }
    
    .issued-to-column a:hover {
        text-decoration: none;
        overflow: visible;
        white-space: normal;
        word-break: break-all;
        position: relative;
        z-index: 10;
        background: white;
        padding: 0.25rem;
        border-radius: 0.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .action-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }
    
    .action-group:last-child {
        margin-bottom: 0;
    }
    
    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        line-height: 1.25;
        transition: all 0.15s ease-in-out;
    }
    
    .action-btn .icon {
        font-size: 0.875rem;
    }
    
    .btn-group {
        display: flex;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .btn-group .action-btn {
        border-radius: 0;
        border-right: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-group .action-btn:first-child {
        border-top-left-radius: 0.375rem;
        border-bottom-left-radius: 0.375rem;
    }
    
    .btn-group .action-btn:last-child {
        border-top-right-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
        border-right: none;
    }
    
    .status-tabs {
        margin-bottom: 1rem;
        border-bottom: 1px solid #dbdbdb;
    }
    
    .status-tabs .tabs {
        margin-bottom: -1px;
    }
    
    .status-tabs .tabs ul {
        border-bottom: none;
    }
    
    .status-tabs .tabs li.is-active a {
        border-bottom-color: #3273dc;
        color: #3273dc;
    }
    
    .status-tab-content {
        min-height: 400px;
    }
</style>
<h1>Manage Badge Grant Records</h1>

<div class="box">
    <div class="columns">
        <div class="column">
            <div class="field">
                <label class="label">Search:</label>
                <div class="control">
                    <input class="input" @bind="searchTerm" placeholder="Search title, recipient, issuer..." />
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">Issued By:</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select @bind="issuerFilter">
                            <option value="">All</option>
                            @foreach (var actor in actors.Values)
                            {
                                <option value="@actor.Uri">@actor.FullName</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">Date Range:</label>
                <div class="control">
                    <input type="date" class="input" @bind="dateFromFilter" />
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">To:</label>
                <div class="control">
                    <input type="date" class="input" @bind="dateToFilter" />
                </div>
            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column">
            <div class="buttons">
                <button class="button is-primary" @onclick="ApplyFilters">Apply Filters</button>
                <button class="button" @onclick="ClearFilters">Clear Filters</button>
            </div>
        </div>
    </div>
</div>

<div class="status-tabs">
    <div class="tabs is-boxed">
        <ul>
            <li class="@(activeTab == "pending" ? "is-active" : "")">
                <a @onclick="SetActiveTabPending">
                    <span class="icon is-small"><i class="fas fa-clock"></i></span>
                    <span>Pending (@GetStatusCount("pending"))</span>
                </a>
            </li>
            <li class="@(activeTab == "accepted" ? "is-active" : "")">
                <a @onclick="SetActiveTabAccepted">
                    <span class="icon is-small"><i class="fas fa-check"></i></span>
                    <span>Accepted (@GetStatusCount("accepted"))</span>
                </a>
            </li>
            <li class="@(activeTab == "processed" ? "is-active" : "")">
                <a @onclick="SetActiveTabProcessed">
                    <span class="icon is-small"><i class="fas fa-cogs"></i></span>
                    <span>Processed (@GetStatusCount("processed"))</span>
                </a>
            </li>
            <li class="@(activeTab == "external" ? "is-active" : "")">
                <a @onclick="SetActiveTabExternal">
                    <span class="icon is-small"><i class="fas fa-external-link-alt"></i></span>
                    <span>External (@GetStatusCount("external"))</span>
                </a>
            </li>
        </ul>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="notification is-danger">
        <button class="delete" @onclick="() => errorMessage = null"></button>
        @errorMessage
    </div>
}

@if (records == null)
{
    <p>Loading...</p>
}
else
{
    <div class="status-tab-content">
        <div class="box">
            <p>Showing @filteredRecords.Count of @records.Count records</p>
        </div>
        <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Badge Title</th>
                <th>Issued To</th>
                <th>Issued By</th>
                <th>Issued On</th>
                <th>Accepted On</th>
                <th class="actions-column">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var record in filteredRecords)
            {
                var actorName = actors.ContainsKey(record.IssuedBy) 
                    ? actors[record.IssuedBy].FullName 
                    : record.IssuedBy.Substring(record.IssuedBy.LastIndexOf('/') + 1);
                
                <tr class="@GetRowClass(record)">
                    <td>@record.Id</td>
                    <td>@record.Title</td>
                    <td class="issued-to-column">
                        @if (!string.IsNullOrEmpty(record.IssuedToSubjectUri))
                        {
                            <a href="@record.IssuedToSubjectUri">@(
                                string.IsNullOrEmpty(record.IssuedToName) ?
                                    string.IsNullOrEmpty(record.IssuedToSubjectUri) ?
                                        MaskEmail(record.IssuedToEmail) :
                                        record.IssuedToSubjectUri
                                        : record.IssuedToName)</a>
                        }
                        else
                        {
                            @(string.IsNullOrEmpty(record.IssuedToName) ?
                                MaskEmail(record.IssuedToEmail) :
                                record.IssuedToName)
                        }
                    </td>
                    <td><a href="@record.IssuedBy">@actorName</a></td>
                    <td>@record.IssuedOn.ToString("yyyy-MM-dd")</td>
                    <td>@(record.AcceptedOn?.ToString("yyyy-MM-dd") ?? "-")</td>
                    <td class="actions-column">
                        @if (record.IsExternal) 
                        {
                            <!-- External Badge Actions -->
                            <div class="action-group">
                                <a href="@record.NoteId" class="action-btn button is-info is-small" title="View external badge">
                                    <span class="icon"><i class="fas fa-external-link-alt"></i></span>
                                    <span>View</span>
                                </a>
                            </div>
                        } 
                        else if (string.IsNullOrEmpty(record.AcceptKey)) 
                        {
                            if (string.IsNullOrEmpty(record.FingerPrint)) 
                            {
                                <!-- Unprocessed Badge Actions -->
                                <div class="action-group">
                                    <a href="/admin/grant/@record.Id/process" class="action-btn button is-primary is-small" title="Process this grant">
                                        <span class="icon"><i class="fas fa-cog"></i></span>
                                        <span>Process</span>
                                    </a>
                                </div>
                            } 
                            else 
                            {
                                <!-- Processed Badge Actions -->
                                <div class="action-group">
                                    <a href="/admin/grant/@record.Id/broadcast" class="action-btn button is-success is-small" title="Propagate to network">
                                        <span class="icon"><i class="fas fa-share-nodes"></i></span>
                                        <span>Propagate</span>
                                    </a>
                                    <a href="@record.NoteId" class="action-btn button is-info is-small" title="View badge post">
                                        <span class="icon"><i class="fas fa-eye"></i></span>
                                        <span>View</span>
                                    </a>
                                </div>
                                
                                <!-- Notification Actions -->
                                <div class="action-group">
                                    <div class="btn-group">
                                        <a href="/admin/grant/@record.Id/notify-processed/activitypub" class="action-btn button is-light is-small" title="Notify recipient via ActivityPub">
                                            <span class="icon"><i class="fab fa-mastodon"></i></span>
                                            <span>ActivityPub</span>
                                        </a>
                                        <a href="/admin/grant/@record.Id/notify-processed/email" class="action-btn button is-light is-small" title="Notify recipient via Email">
                                            <span class="icon"><i class="fas fa-envelope"></i></span>
                                            <span>Email</span>
                                        </a>
                                    </div>
                                </div>
                            }
                        } 
                        else 
                        {
                            <!-- Pending Acceptance Actions -->
                            <div class="action-group">
                                <a href="/accept/grant/@record.Id/@record.AcceptKey" class="action-btn button is-link is-small" title="Direct acceptance link">
                                    <span class="icon"><i class="fas fa-link"></i></span>
                                    <span>Accept Link</span>
                                </a>
                            </div>
                            
                            <!-- Notification Actions -->
                            <div class="action-group">
                                <div class="btn-group">
                                    <a href="/admin/grant/@record.Id/notify/activitypub" class="action-btn button is-light is-small" title="Send notification via ActivityPub">
                                        <span class="icon"><i class="fab fa-mastodon"></i></span>
                                        <span>Notify AP</span>
                                    </a>
                                    <a href="/admin/grant/@record.Id/notify/email" class="action-btn button is-light is-small" title="Send notification via Email">
                                        <span class="icon"><i class="fas fa-envelope"></i></span>
                                        <span>Notify Email</span>
                                    </a>
                                </div>
                            </div>
                        }
               
                        @{
                            bool canDelete = (!record.AcceptedOn.HasValue && string.IsNullOrEmpty(record.FingerPrint));
                        }

                        @if (!record.IsExternal)
                        {
                            <!-- Destructive Actions -->
                            <div class="action-group">
                                @if (canDelete) 
                                {
                                    <button class="action-btn button is-danger is-small" @onclick="() => ShowDeleteConfirmation(record)" title="Permanently delete this grant">
                                        <span class="icon"><i class="fas fa-trash-alt"></i></span>
                                        <span>Delete</span>
                                    </button>
                                } 
                                else 
                                {
                                    <button class="action-btn button is-warning is-small" @onclick="() => ShowRevokeConfirmation(record)" title="Revoke this badge grant">
                                        <span class="icon"><i class="fas fa-ban"></i></span>
                                        <span>Revoke</span>
                                    </button>
                                }
                            </div>
                        }
                    </td>
                </tr>
            }
        </tbody>
        </table>
    </div>
}

@if (showRevokeConfirmation && recordToDelete != null)
{
     <div class="modal is-active">
        <div class="modal-background" @onclick="HideRevokeConfirmation"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Confirm Revocation</p>
                <button class="delete" aria-label="close" @onclick="HideRevokeConfirmation"></button>
            </header>
            <section class="modal-card-body">
                <p>Are you sure you want to revoke the badge grant "<strong>@recordToDelete.Title</strong>" issued to <strong>@recordToDelete.IssuedToName</strong>?</p>
                    <p class="has-text-danger mt-3">
                        <strong>This action cannot be undone.</strong> 
                        The grant will be revoked immediately on this server.
                        A notification will be sent to the network to initiate revocation on other sites.
                        However, due to the decentralized nature of the system, the revocation on other sites may not be immediate and depends on their processing schedules.
                    </p>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" @onclick="ConfirmRevoke">Revoke</button>
                <button class="button" @onclick="HideRevokeConfirmation">Cancel</button>
            </footer>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation && recordToDelete != null)
{
    <div class="modal is-active">
        <div class="modal-background" @onclick="HideDeleteConfirmation"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Confirm Delete</p>
                <button class="delete" aria-label="close" @onclick="HideDeleteConfirmation"></button>
            </header>
            <section class="modal-card-body">
                @if (recordToDelete.IsExternal)
                {
                    <div class="notification is-warning">
                        <strong>Warning:</strong> This is an external badge grant. Deleting it locally will not remove the grant from the original server. 
                        This action only removes the record from your local database and will not affect the original badge on the issuing server.
                    </div>
                }
                <p>Are you sure you want to delete the badge grant "<strong>@recordToDelete.Title</strong>" issued to <strong>@recordToDelete.IssuedToName</strong>?</p>
                @if (!recordToDelete.IsExternal)
                {
                    <p class="has-text-danger mt-3">
                        <strong>This action cannot be undone.</strong> The grant will be permanently removed and the recipient will no longer be able to accept it.
                    </p>
                }
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" @onclick="ConfirmDelete">Delete</button>
                <button class="button" @onclick="HideDeleteConfirmation">Cancel</button>
            </footer>
        </div>
    </div>
}

@code {
    private List<BadgeRecord?> records;
    private List<BadgeRecord?> filteredRecords = new List<BadgeRecord?>();

    private Dictionary<string, Actor> actors;

    private string errorMessage;

    // Filter properties
    private string searchTerm = "";
    private string issuerFilter = "";
    private DateTime? dateFromFilter;
    private DateTime? dateToFilter;
    
    // Tab properties
    private string activeTab = "pending";

    // Delete confirmation modal properties
    private bool showDeleteConfirmation = false;

    private bool showRevokeConfirmation = false;
    private BadgeRecord? recordToDelete = null;

    private string MaskEmail(string email) {
        if (string.IsNullOrEmpty(email)) return "";

        var atIndex = email.IndexOf('@');
        if (atIndex <= 1) return "****" + email.Substring(atIndex);

        return email.Substring(0, 1) + "****" + email.Substring(atIndex - 1);
    }

    private void PerformSearch() {
        var filter = new LocalDbService.Filter();

        var whereClauses = new List<string>() {
            "RevokedAt IS NULL"
        };

        if (!string.IsNullOrEmpty(searchTerm)) {
            whereClauses.Add("(br.Title LIKE @Term OR br.IssuedToSubjectUri LIKE @Term OR br.IssuedBy LIKE @Term)");
            filter.Parameters.Add("Term", $"%{searchTerm}%");
        }

        if (!CurrentUser.IsAdmin() && false) { //FIXME
            whereClauses.Add("br.OwnerId = @OwnerId");
            filter.Parameters.Add("OwnerId", CurrentUser.GetGroupId());
        }

        filter.Where = string.Join(" AND ", whereClauses);
        
        records = LocalDbService.GetBadgeRecords(filter, true)!;
    }

    private void ApplyFilters() {
        PerformSearch();

        if (records == null) return;
        
        filteredRecords = records.Where(r => {
            bool matchesStatus = GetRecordStatus(r) == activeTab;
            bool matchesIssuer = string.IsNullOrEmpty(issuerFilter) || r.IssuedBy == issuerFilter;
            bool matchesDateFrom = !dateFromFilter.HasValue || r.IssuedOn >= dateFromFilter.Value;
            bool matchesDateTo = !dateToFilter.HasValue || r.IssuedOn <= dateToFilter.Value.AddDays(1);
            
            return matchesStatus && matchesIssuer && matchesDateFrom && matchesDateTo;
        }).ToList();
    }

    private void ClearFilters() {
        searchTerm = "";
        issuerFilter = "";
        dateFromFilter = null;
        dateToFilter = null;
        
        ApplyFilters();
    }

    private string GetRecordStatus(BadgeRecord record) {
        if (record.IsExternal) {
            return "external";
        } else if (!string.IsNullOrEmpty(record.FingerPrint)) {
            return "processed";
        } else if (record.AcceptedOn.HasValue) {
            return "accepted";
        } else {
            return "pending";
        }
    }

    private string GetRowClass(BadgeRecord record) {
        string status = GetRecordStatus(record);
        return status switch {
            "processed" => "has-background-success-light",
            "accepted" => "has-background-info-light",
            "external" => "has-background-warning-light",
            _ => ""
        };
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        ApplyFilters();
    }
    
    private void SetActiveTabPending()
    {
        activeTab = "pending";
        ApplyFilters();
    }
    
    private void SetActiveTabAccepted()
    {
        activeTab = "accepted";
        ApplyFilters();
    }
    
    private void SetActiveTabProcessed()
    {
        activeTab = "processed";
        ApplyFilters();
    }
    
    private void SetActiveTabExternal()
    {
        activeTab = "external";
        ApplyFilters();
    }
    
    private int GetStatusCount(string status)
    {
        if (records == null) return 0;
        return records.Count(r => GetRecordStatus(r) == status);
    }

    protected override async Task OnInitializedAsync()
    {
        var actorList = LocalDbService.GetActors();

        actors = actorList.ToDictionary(a => a.Uri!.ToString());

        PerformSearch();
        ApplyFilters();
    }

    private void ShowDeleteConfirmation(BadgeRecord record)
    {
        recordToDelete = record;
        showDeleteConfirmation = true;  
    }

    private void ShowRevokeConfirmation(BadgeRecord record)
    {
        // For simplicity, using the same modal for revoke confirmation
        recordToDelete = record;
        showRevokeConfirmation = true;
    }

    private void HideRevokeConfirmation()
    {
        recordToDelete = null;
        showRevokeConfirmation = false;
    }

    private void HideDeleteConfirmation()
    {
        recordToDelete = null;
        showDeleteConfirmation = false;
    }

    private void ConfirmRevoke()
    {
        if (recordToDelete != null)
        {
            try
            {
                LocalDbService.RevokeGrantById(recordToDelete.Id);
                
                // Refresh the data
                PerformSearch();
                ApplyFilters();
                
                HideRevokeConfirmation();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error revoking badge record: {ex.Message}";
            }
        }
    }

    private void ConfirmDelete()
    {
        if (recordToDelete != null)
        {
            try
            {
                LocalDbService.DeleteBadgeRecord(recordToDelete.Id);
                
                // Refresh the data
                PerformSearch();
                ApplyFilters();
                
                HideDeleteConfirmation();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error deleting badge record: {ex.Message}";
            }
        }
    }
}
