@page "/admin/grants"

@using System.IO
@using Microsoft.AspNetCore.Hosting
@using Microsoft.AspNetCore.Components.Forms
@inject IWebHostEnvironment Environment
@inject NavigationManager NavigationManager
@inject LocalScopedDb LocalDbService
@inject CurrentUser CurrentUser
@layout BadgeFed.Components.Layouts.AdminLayout
@rendermode InteractiveServer

@attribute [Authorize(Roles = "admin, manager")]
<h1>Manage Badge Grant Records</h1>

<div class="box">
    <div class="columns">
        <div class="column">
            <div class="field">
                <label class="label">Search:</label>
                <div class="control">
                    <input class="input" @bind="searchTerm" placeholder="Search title, recipient, issuer..." />
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">Status:</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select @bind="statusFilter">
                            <option value="">All</option>
                            <option value="pending">Pending Acceptance</option>
                            <option value="accepted">Accepted</option>
                            <option value="processed">Processed</option>
                            <option value="external">External</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">Issued By:</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select @bind="issuerFilter">
                            <option value="">All</option>
                            @foreach (var actor in actors.Values)
                            {
                                <option value="@actor.Uri">@actor.FullName</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">Date Range:</label>
                <div class="control">
                    <input type="date" class="input" @bind="dateFromFilter" />
                </div>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">To:</label>
                <div class="control">
                    <input type="date" class="input" @bind="dateToFilter" />
                </div>
            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column">
            <div class="buttons">
                <button class="button is-primary" @onclick="ApplyFilters">Apply Filters</button>
                <button class="button" @onclick="ClearFilters">Clear Filters</button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="notification is-danger">
        <button class="delete" @onclick="() => errorMessage = null"></button>
        @errorMessage
    </div>
}

@if (records == null)
{
    <p>Loading...</p>
}
else
{
    <div class="box">
        <p>Showing @filteredRecords.Count of @records.Count records</p>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Badge Title</th>
                <th>Issued To</th>
                <th>Issued By</th>
                <th>Issued On</th>
                <th>Accepted On</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var record in filteredRecords)
            {
                var actorName = actors.ContainsKey(record.IssuedBy) 
                    ? actors[record.IssuedBy].FullName 
                    : record.IssuedBy.Substring(record.IssuedBy.LastIndexOf('/') + 1);
                
                <tr class="@GetRowClass(record)">
                    <td>@record.Id</td>
                    <td>@record.Title</td>
                    <td><a href="@record.IssuedToSubjectUri">@(
                        string.IsNullOrEmpty(record.IssuedToName) ?
                            string.IsNullOrEmpty(record.IssuedToSubjectUri) ?
                                MaskEmail(record.IssuedToEmail) :
                                record.IssuedToSubjectUri
                                : record.IssuedToName)</a></td>
                    <td><a href="@record.IssuedBy">@actorName</a></td>
                    <td>@record.IssuedOn.ToString("yyyy-MM-dd")</td>
                    <td>@(record.AcceptedOn?.ToString("yyyy-MM-dd") ?? "-")</td>
                    <td>
                        @if (record.IsExternal) {
                            <a href="@record.NoteId" class="button is-info is-small">View</a>
                        } else if (string.IsNullOrEmpty(record.AcceptKey)) {
                            if (string.IsNullOrEmpty(record.FingerPrint)) {
                                <a href="/admin/grant/@record.Id/process" class="button is-primary is-small">Process</a>
                            } else {
                                <a href="/admin/grant/@record.Id/broadcast" class="button is-light is-small">Propagate</a>

                                <a href="@record.NoteId" class="button is-info is-small">View</a>

                                <div class="buttons">
                                    <a href="/admin/grant/@record.Id/notify-processed/activitypub" class="button is-light is-small" title="Notify via ActivityPub">
                                        <span class="icon">
                                            <i class="fas fa-broadcast-tower"></i>
                                        </span>
                                        <span>ActivityPub</span>
                                    </a>
                                    <a href="/admin/grant/@record.Id/notify-processed/email" class="button is-light is-small" title="Notify via Email">
                                        <span class="icon">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <span>Email</span>
                                    </a>
                                </div>
                            }
                        } else {
                            <a href="/accept/grant/@record.Id/@record.AcceptKey" class="button is-link is-small">
                                <span class="icon">
                                    <i class="fas fa-check"></i>
                                </span>
                                <span>Accept Link</span>
                            </a>

                            <div class="buttons">
                                <a href="/admin/grant/@record.Id/notify/activitypub" class="button is-light is-small" title="Notify via ActivityPub">
                                    <span class="icon">
                                        <i class="fas fa-broadcast-tower"></i>
                                    </span>
                                    <span>Notify via ActivityPub</span>
                                </a>
                                <a href="/admin/grant/@record.Id/notify/email" class="button is-light is-small" title="Notify via Email">
                                    <span class="icon">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    <span>Notify via Email</span>
                                </a>
                            </div>
                        }
               
                        @{
                            bool canDelete = (!record.AcceptedOn.HasValue && string.IsNullOrEmpty(record.FingerPrint));
                        }

                        @if (!record.IsExternal)
                        {
                            if (canDelete) {
                                <button class="button is-danger is-small" @onclick="() => ShowDeleteConfirmation(record)">
                                    <span class="icon">
                                        <i class="fas fa-trash"></i>
                                    </span>
                                    <span>Delete</span>
                                </button>
                            } else {
                                <button class="button is-warning is-small" @onclick="() => ShowRevokeConfirmation(record)">
                                    <span class="icon">
                                        <i class="fas fa-trash"></i>
                                    </span>
                                    <span>Revoke</span>
                                </button>
                            }

                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (showRevokeConfirmation && recordToDelete != null)
{
     <div class="modal is-active">
        <div class="modal-background" @onclick="HideRevokeConfirmation"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Confirm Revocation</p>
                <button class="delete" aria-label="close" @onclick="HideRevokeConfirmation"></button>
            </header>
            <section class="modal-card-body">
                <p>Are you sure you want to revoke the badge grant "<strong>@recordToDelete.Title</strong>" issued to <strong>@recordToDelete.IssuedToName</strong>?</p>
                    <p class="has-text-danger mt-3">
                        <strong>This action cannot be undone.</strong> 
                        The grant will be revoked immediately on this server.
                        A notification will be sent to the network to initiate revocation on other sites.
                        However, due to the decentralized nature of the system, the revocation on other sites may not be immediate and depends on their processing schedules.
                    </p>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" @onclick="ConfirmRevoke">Revoke</button>
                <button class="button" @onclick="HideRevokeConfirmation">Cancel</button>
            </footer>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation && recordToDelete != null)
{
    <div class="modal is-active">
        <div class="modal-background" @onclick="HideDeleteConfirmation"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Confirm Delete</p>
                <button class="delete" aria-label="close" @onclick="HideDeleteConfirmation"></button>
            </header>
            <section class="modal-card-body">
                @if (recordToDelete.IsExternal)
                {
                    <div class="notification is-warning">
                        <strong>Warning:</strong> This is an external badge grant. Deleting it locally will not remove the grant from the original server. 
                        This action only removes the record from your local database and will not affect the original badge on the issuing server.
                    </div>
                }
                <p>Are you sure you want to delete the badge grant "<strong>@recordToDelete.Title</strong>" issued to <strong>@recordToDelete.IssuedToName</strong>?</p>
                @if (!recordToDelete.IsExternal)
                {
                    <p class="has-text-danger mt-3">
                        <strong>This action cannot be undone.</strong> The grant will be permanently removed and the recipient will no longer be able to accept it.
                    </p>
                }
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" @onclick="ConfirmDelete">Delete</button>
                <button class="button" @onclick="HideDeleteConfirmation">Cancel</button>
            </footer>
        </div>
    </div>
}

@code {
    private List<BadgeRecord?> records;
    private List<BadgeRecord?> filteredRecords = new List<BadgeRecord?>();

    private Dictionary<string, Actor> actors;

    private string errorMessage;

    // Filter properties
    private string searchTerm = "";
    private string statusFilter = "";
    private string issuerFilter = "";
    private DateTime? dateFromFilter;
    private DateTime? dateToFilter;

    // Delete confirmation modal properties
    private bool showDeleteConfirmation = false;

    private bool showRevokeConfirmation = false;
    private BadgeRecord? recordToDelete = null;

    private string MaskEmail(string email) {
        if (string.IsNullOrEmpty(email)) return "";

        var atIndex = email.IndexOf('@');
        if (atIndex <= 1) return "****" + email.Substring(atIndex);

        return email.Substring(0, 1) + "****" + email.Substring(atIndex - 1);
    }

    private void PerformSearch() {
        var filter = new LocalDbService.Filter();

        var whereClauses = new List<string>() {
            "RevokedAt IS NULL"
        };

        if (!string.IsNullOrEmpty(searchTerm)) {
            whereClauses.Add("(Title LIKE @Term OR IssuedToSubjectUri LIKE @Term OR IssuedBy LIKE @Term)");
            filter.Parameters.Add("Term", $"%{searchTerm}%");
        }

        if (!CurrentUser.IsAdmin() && false) { //FIXME
            whereClauses.Add("OwnerId = @OwnerId");
            filter.Parameters.Add("OwnerId", CurrentUser.GetGroupId());
        }

        filter.Where = string.Join(" AND ", whereClauses);

        Console.WriteLine(System.Text.Json.JsonSerializer.Serialize(filter));
        
        records = LocalDbService.GetBadgeRecords(filter, true)!;
    }

    private void ApplyFilters() {
        PerformSearch();

        if (records == null) return;
        
        filteredRecords = records.Where(r => {
            bool matchesStatus = string.IsNullOrEmpty(statusFilter) || GetRecordStatus(r) == statusFilter;
            bool matchesIssuer = string.IsNullOrEmpty(issuerFilter) || r.IssuedBy == issuerFilter;
            bool matchesDateFrom = !dateFromFilter.HasValue || r.IssuedOn >= dateFromFilter.Value;
            bool matchesDateTo = !dateToFilter.HasValue || r.IssuedOn <= dateToFilter.Value.AddDays(1);
            
            return matchesStatus && matchesIssuer && matchesDateFrom && matchesDateTo;
        }).ToList();
    }

    private void ClearFilters() {
        searchTerm = "";
        statusFilter = "";
        issuerFilter = "";
        dateFromFilter = null;
        dateToFilter = null;
        
        PerformSearch();
        
        filteredRecords = new List<BadgeRecord?>(records);
    }

    private string GetRecordStatus(BadgeRecord record) {
        if (record.IsExternal) {
            return "external";
        } else if (!string.IsNullOrEmpty(record.FingerPrint)) {
            return "processed";
        } else if (record.AcceptedOn.HasValue) {
            return "accepted";
        } else {
            return "pending";
        }
    }

    private string GetRowClass(BadgeRecord record) {
        string status = GetRecordStatus(record);
        return status switch {
            "processed" => "has-background-success-light",
            "accepted" => "has-background-info-light",
            "external" => "has-background-warning-light",
            _ => ""
        };
    }

    protected override async Task OnInitializedAsync()
    {
        var actorList = LocalDbService.GetActors();

        actors = actorList.ToDictionary(a => a.Uri!.ToString());

        PerformSearch();

        filteredRecords = new List<BadgeRecord?>(records);
    }

    private void ShowDeleteConfirmation(BadgeRecord record)
    {
        recordToDelete = record;
        showDeleteConfirmation = true;  
    }

    private void ShowRevokeConfirmation(BadgeRecord record)
    {
        // For simplicity, using the same modal for revoke confirmation
        recordToDelete = record;
        showRevokeConfirmation = true;
    }

    private void HideRevokeConfirmation()
    {
        recordToDelete = null;
        showRevokeConfirmation = false;
    }

    private void HideDeleteConfirmation()
    {
        recordToDelete = null;
        showDeleteConfirmation = false;
    }

    private void ConfirmRevoke()
    {
        if (recordToDelete != null)
        {
            try
            {
                LocalDbService.RevokeGrantById(recordToDelete.Id);
                
                // Refresh the data
                PerformSearch();
                ApplyFilters();
                
                HideRevokeConfirmation();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error revoking badge record: {ex.Message}";
            }
        }
    }

    private void ConfirmDelete()
    {
        if (recordToDelete != null)
        {
            try
            {
                LocalDbService.DeleteBadgeRecord(recordToDelete.Id);
                
                // Refresh the data
                PerformSearch();
                ApplyFilters();
                
                HideDeleteConfirmation();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error deleting badge record: {ex.Message}";
            }
        }
    }
}
