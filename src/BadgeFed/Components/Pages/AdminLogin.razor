@page "/admin/login"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Authentication;
@using Microsoft.AspNetCore.Authentication.Cookies;
@using Microsoft.AspNetCore.Authorization;
@using System.Security.Claims;
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IHttpContextAccessor HttpContextAccessor
@inject HttpClient Http
@inject ProtectedSessionStorage ProtectedSessionStore
@inject IJSRuntime JS
@rendermode InteractiveServer

<section class="section">
    <div class="container">
        <div class="columns is-centered">
            <div class="column is-4">
                <div class="box">
                    <h2 class="title is-4 has-text-centered">Welcome to BadgeFed Admin</h2>
                    
                    @if (User.Identity.Name != null)
                    {
                        <p class="has-text-centered">Loading...</p>
                    }
                    else
                    {
                        <p class="has-text-centered mb-4">Login with your accounts</p>
                        
                        @if (IsMastodonConfigured)
                        {
                            <div class="field mb-3">
                                <div class="mastodon-login-container">
                                    @if (!showMastodonDropdown)
                                    {
                                        <div class="control">
                                            <button class="button is-fullwidth is-primary has-background-purple"
                                                    @onclick="ToggleMastodonDropdown">
                                                <span class="icon">
                                                    <i class="fab fa-mastodon"></i>
                                                </span>
                                                <span>Sign In with Mastodon</span>
                                                <span class="icon is-small ml-2">
                                                    <i class="fas fa-chevron-down"></i>
                                                </span>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mastodon-dropdown-card">
                                            <div class="dropdown-header">
                                                <h5 class="title is-6 mb-3">
                                                    <span class="icon">
                                                        <i class="fab fa-mastodon"></i>
                                                    </span>
                                                    Choose your Mastodon server
                                                </h5>
                                                <button class="delete is-small" @onclick="CloseMastodonDropdown"></button>
                                            </div>
                                            
                                            <div class="field">
                                                <div class="control has-icons-left">
                                                    <input class="input" type="text" placeholder="Search or enter server (e.g., mastodon.social)"
                                                           @bind="selectedMastodonServer" @oninput="OnMastodonServerInput" @ref="mastodonInputRef" />
                                                    <span class="icon is-small is-left">
                                                        <i class="fas fa-search"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            @if (filteredMastodonServers.Any())
                                            {
                                                <div class="server-suggestions">
                                                    @foreach (var server in filteredMastodonServers.Take(5))
                                                    {
                                                        <div class="server-suggestion" @onclick="() => SelectMastodonServer(server.Domain)">
                                                            <div class="server-info">
                                                                <strong>@server.Domain</strong>
                                                                <small class="has-text-grey">@server.Description</small>
                                                            </div>
                                                            <span class="tag is-light">@server.Users users</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            
                                            <div class="field mt-4">
                                                <div class="control">
                                                    <button class="button is-fullwidth has-background-purple" 
                                                            @onclick="SignInWithSelectedMastodonServer"
                                                            disabled="@(string.IsNullOrWhiteSpace(selectedMastodonServer))">
                                                        <span class="icon">
                                                            <i class="fab fa-mastodon"></i>
                                                        </span>
                                                        <span>Continue with @(string.IsNullOrWhiteSpace(selectedMastodonServer) ? "..." : selectedMastodonServer)</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (IsGotoSocialConfigured)
                        {
                            <div class="field mb-3">
                                <div class="control">
                                    <button class="button is-fullwidth is-primary has-background-orange"
                                            @onclick="SignInWithGotoSocial">
                                        <span class="icon">
                                            <i class="fab fa-gotosocial"></i>
                                        </span>
                                        <span>Sign In with GoToSocial</span>
                                    </button>
                                </div>
                            </div>
                        }

                        @if (IsLinkedInConfigured)
                        {
                            <div class="field mb-3">
                                <div class="control">
                                    <button class="button is-fullwidth is-info"
                                            @onclick="SignInWithLinkedIn">
                                        <span class="icon">
                                            <i class="fab fa-linkedin"></i>
                                        </span>
                                        <span>Sign In with LinkedIn</span>
                                    </button>
                                </div>
                            </div>
                        }
                        @if (IsGoogleConfigured)
                        {
                            <div class="field">
                                <div class="control">
                                    <button class="button is-fullwidth is-danger"
                                            @onclick="SignInWithGoogle">
                                        <span class="icon">
                                            <i class="fab fa-google"></i>
                                        </span>
                                        <span>Sign In with Google</span>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .has-background-purple {
        background-color: #6d00b6 !important;
        color: white !important;
    }
    .has-background-purple:hover {
        background-color: #5b009a !important;
    }

    .has-background-orange {
        background-color: #ff8c00 !important;
        color: white !important;
    }

    .has-background-orange:hover {
        background-color: #e07b00 !important;
    }

    .mastodon-login-container {
        position: relative;
    }

    .mastodon-dropdown-card {
        background: white;
        border: 1px solid #dbdbdb;
        border-radius: 6px;
        padding: 1.5rem;
        box-shadow: 0 8px 16px rgba(10, 10, 10, 0.1);
        animation: fadeInDown 0.2s ease-out;
    }

    .dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .server-suggestions {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dbdbdb;
        border-radius: 4px;
        margin-top: 0.5rem;
    }

    .server-suggestion {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .server-suggestion:last-child {
        border-bottom: none;
    }

    .server-suggestion:hover {
        background-color: #f8f9fa;
    }

    .server-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .server-info small {
        margin-top: 0.25rem;
        font-size: 0.75rem;
    }

    @@keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* GoToSocial sloth */
    .fab.fa-gotosocial::before {
        content: "";
        display: inline-block;
        width: 1em;
        height: 1em;
        background: currentColor;
        vertical-align: -0.125em;

        /* Stylized sloth icon (Font-Awesome-like) encoded as a data URI.
           White areas are visible; black areas create small cutouts (eyes/mouth). */
        --gts-sloth: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="%23ffffff" d="M32 6c-7 0-12 4-16 9-6 7-6 16-4 22 2 6 7 11 13 14 6 3 27 6 31-1 4-7 1-18-3-24-4-6-9-12-21-20z"/><circle fill="%23000000" cx="23" cy="28" r="3"/><circle fill="%23000000" cx="41" cy="28" r="3"/><path fill="%23000000" d="M32 35c-3 0-6 3-6 4 0 1 3 2 6 2s6-1 6-2c0-1-3-4-6-4z"/></svg>');

        -webkit-mask-image: var(--gts-sloth);
        mask-image: var(--gts-sloth);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-position: center;
        mask-position: center;
        -webkit-mask-size: contain;
        mask-size: contain;

    }
</style>

<style>
    .btn-facebook {
        background-color: #4267B2;
        color: white;
    }

    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
        background-color: #f5f5f5;
    }

    .login-box {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    .oauth-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: opacity 0.2s;
    }

    .btn:hover {
        opacity: 0.9;
    }

    .btn-mastodon {
        background-color: #6d00b6;
        color: white;
    }

    .logged-in-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .avatar-container {
        display: flex;
        justify-content: center;
        margin-bottom: 1rem;
        width: 100%;
    }

    .user-avatar, .avatar-placeholder {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        margin: 0 auto;
    }

    .avatar-placeholder {
        background-color: #4a90e2;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .user-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        width: 100%;
        text-align: center;
    }

    .logout-form {
        margin-top: 0.5rem;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .btn-logout {
        background-color: #ff4d4d;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-width: 120px;
    }

    .btn-logout:hover {
        background-color: #e60000;
    }
</style>

@code {
    private ClaimsPrincipal User;

    private string GivenName;
    private string Surname;
    private string Avatar;

    private bool IsMastodonConfigured;
    private bool IsGotoSocialConfigured;
    private bool IsLinkedInConfigured;
    private bool IsGoogleConfigured;

    private string mastodonServer;
    private string gotoSocialServer;
    
    // Mastodon dropdown state
    private bool showMastodonDropdown = false;
    private string selectedMastodonServer = "";
    private ElementReference mastodonInputRef;
    
    // Popular Mastodon servers for suggestions
    private List<MastodonServer> popularMastodonServers = new()
    {
        new("mastodon.social", "The original server run by the Mastodon team", "786K"),
        new("mastodon.world", "A general-purpose Mastodon server", "156K"),
        new("mas.to", "A safe, friendly community", "47K"),
        new("fosstodon.org", "A community for free and open source software", "32K"),
        new("mstdn.social", "A general-purpose community server", "28K"),
        new("infosec.exchange", "InfoSec community on Mastodon", "25K"),
        new("hachyderm.io", "Safe space for tech workers and enthusiasts", "24K"),
        new("techhub.social", "Technology professionals and enthusiasts", "18K"),
        new("mastodon.online", "A fast, secure and up-to-date instance", "15K")
    };
    
    private List<MastodonServer> filteredMastodonServers => 
        string.IsNullOrWhiteSpace(selectedMastodonServer) 
            ? popularMastodonServers
            : popularMastodonServers.Where(s => 
                s.Domain.Contains(selectedMastodonServer, StringComparison.OrdinalIgnoreCase) ||
                s.Description.Contains(selectedMastodonServer, StringComparison.OrdinalIgnoreCase)
              ).ToList();

    public record MastodonServer(string Domain, string Description, string Users);
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        try
        {
            // Set the user to determine if they are logged in
            User = HttpContextAccessor.HttpContext.User;

            // Check if MastodonConfig is present
            var mastodonSection = Configuration.GetSection("MastodonConfig");
            IsMastodonConfigured = !string.IsNullOrEmpty(mastodonSection["ClientId"]) &&
                                   !string.IsNullOrEmpty(mastodonSection["ClientSecret"]) &&
                                   !string.IsNullOrEmpty(mastodonSection["Server"]);

            if (IsMastodonConfigured) {
                mastodonServer = mastodonSection["Server"];
            }

            // Check if GotoSocialConfig is present
            var gotoSocialSection = Configuration.GetSection("GotoSocialConfig");
            IsGotoSocialConfigured = !string.IsNullOrEmpty(gotoSocialSection["Server"]);

            if (IsGotoSocialConfigured) {
                gotoSocialServer = gotoSocialSection["Server"];
            }

            // Check if LinkedInConfig is present
            var linkedInSection = Configuration.GetSection("LinkedInConfig");
            IsLinkedInConfigured = !string.IsNullOrEmpty(linkedInSection["ClientId"]) &&
                                   !string.IsNullOrEmpty(linkedInSection["ClientSecret"]);

            // Check if GoogleConfig is present
            var googleSection = Configuration.GetSection("GoogleConfig");
            IsGoogleConfigured = !string.IsNullOrEmpty(googleSection["ClientId"]) &&
                                 !string.IsNullOrEmpty(googleSection["ClientSecret"]);


            if (User != null)
            {
                await OpenApp();
                return;
            }

            // Try to get the GivenName
            var givenName =
                HttpContextAccessor.HttpContext.User
                .FindFirst(ClaimTypes.GivenName);

            if (givenName != null)
            {
                GivenName = givenName.Value;
            }
            else
            {
                GivenName = User.Identity.Name;
            }
            // Try to get the Surname
            var surname =
                HttpContextAccessor.HttpContext.User
                .FindFirst(ClaimTypes.Surname);
            if (surname != null)
            {
                Surname = surname.Value;
            }
            else
            {
                Surname = "";
            }
            // Try to get Avatar
            var avatar =
            HttpContextAccessor.HttpContext.User
            .FindFirst("urn:google:image");
            if (avatar != null)
            {
                Avatar = avatar.Value;
            }
            else
            {
                Avatar = "";
            }
        }
        catch {

        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("invitationCode", out var invitationCode))
        {
            // Store the invitation code in session storage
            await JS.InvokeVoidAsync("setCookie", "invitationCode", invitationCode, 1);
        }
    }

    private async Task SignInWithMastodon()
    {
        var invitationCode = await GetInvitationCodeFromUrl();
        var url = $"admin/login/oauth/{mastodonServer}?returnUrl=/admin/";
        if (!string.IsNullOrEmpty(invitationCode))
        {
            url += $"&invitationCode={invitationCode}";
        }
        NavigationManager.NavigateTo(url);
    }

    private void ToggleMastodonDropdown()
    {
        showMastodonDropdown = true;
        selectedMastodonServer = mastodonServer; // Default to configured server
        StateHasChanged();
        
        // Focus the input after the DOM updates
        _ = Task.Run(async () =>
        {
            await Task.Delay(100);
            await InvokeAsync(async () =>
            {
                try
                {
                    await mastodonInputRef.FocusAsync();
                }
                catch { }
            });
        });
    }

    private void CloseMastodonDropdown()
    {
        showMastodonDropdown = false;
        StateHasChanged();
    }

    private void OnMastodonServerInput(ChangeEventArgs e)
    {
        selectedMastodonServer = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private void SelectMastodonServer(string server)
    {
        selectedMastodonServer = server;
        StateHasChanged();
    }

    private async Task SignInWithSelectedMastodonServer()
    {
        if (string.IsNullOrWhiteSpace(selectedMastodonServer))
            return;

        // Clean up the server URL (remove protocol if present)
        var cleanServer = selectedMastodonServer.Trim();
        if (cleanServer.StartsWith("https://"))
            cleanServer = cleanServer.Substring(8);
        if (cleanServer.StartsWith("http://"))
            cleanServer = cleanServer.Substring(7);

        var invitationCode = await GetInvitationCodeFromUrl();
        var url = $"admin/login/oauth/{cleanServer}?returnUrl=/admin/";
        if (!string.IsNullOrEmpty(invitationCode))
        {
            url += $"&invitationCode={invitationCode}";
        }
        NavigationManager.NavigateTo(url);
    }

    private async Task SignInWithGotoSocial()
    {
        var invitationCode = await GetInvitationCodeFromUrl();
        var url = $"admin/login/oauth/{gotoSocialServer}?returnUrl=/admin/";
        if (!string.IsNullOrEmpty(invitationCode))
        {
            url += $"&invitationCode={invitationCode}";
        }
        NavigationManager.NavigateTo(url);
    }
    
    private async Task SignInWithLinkedIn()
    {
        var invitationCode = await GetInvitationCodeFromUrl();
        var url = $"admin/login/linkedin?returnUrl=/admin/";
        if (!string.IsNullOrEmpty(invitationCode))
        {
            url += $"&invitationCode={invitationCode}";
        }
        NavigationManager.NavigateTo(url);
    }

    private async Task SignInWithGoogle()
    {
        var invitationCode = await GetInvitationCodeFromUrl();
        var url = $"admin/login/google?returnUrl=/admin/";
        if (!string.IsNullOrEmpty(invitationCode))
        {
            url += $"&invitationCode={invitationCode}";
        }
        NavigationManager.NavigateTo(url);
    }

    private async Task<string?> GetInvitationCodeFromUrl()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("invitationCode", out var invitationCode))
        {
            return invitationCode.ToString();
        }
        
        // Try to get from session storage as fallback
        try
        {
            var storedCode = await ProtectedSessionStore.GetAsync<string>("invitationCode");
            return storedCode.Success ? storedCode.Value : null;
        }
        catch
        {
            return null;
        }
    }

    private async Task OpenApp()
    {
       /* var user = await DBService.GetUserByIdAsync(CurrentUser!.UserId);
        if (user == null) {
            NavigationManager.NavigateTo("/setup");
        } else {
            NavigationManager.NavigateTo("/manage-content");
        }*/
        
    }
    private string GetInitials(string firstName, string lastName)
    {
        string initials = "";
        
        if (!string.IsNullOrEmpty(firstName))
            initials += firstName[0];
            
        if (!string.IsNullOrEmpty(lastName))
            initials += lastName[0];
            
        return initials;
    }
}
